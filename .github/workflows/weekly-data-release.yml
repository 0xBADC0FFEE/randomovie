name: Weekly Data Release

on:
  schedule:
    - cron: '17 3 * * 0'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: weekly-data-release
  cancel-in-progress: true

jobs:
  build-and-publish-data:
    runs-on: ubuntu-latest
    env:
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      FULL_RECOMPUTE_EVERY_WEEKS: 8
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore embedding cache
        uses: actions/cache@v4
        with:
          path: scripts/embedding_cache.npz
          key: embedding-cache-v2-${{ runner.os }}-${{ hashFiles('scripts/pipeline.py') }}
          restore-keys: |
            embedding-cache-v2-${{ runner.os }}-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install kagglehub pandas numpy umap-learn requests sentence-transformers

      - name: Generate embeddings + metadata
        run: |
          python scripts/pipeline.py \
            --ci \
            --embed-backend sentence-transformers \
            --cache-prune \
            --full-recompute-every-weeks "${FULL_RECOMPUTE_EVERY_WEEKS}"

      - name: Publish bins to data-latest branch
        run: |
          set -euo pipefail
          rm -rf /tmp/data-latest
          git clone --depth=1 "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" /tmp/data-latest

          cd /tmp/data-latest
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin data-latest >/dev/null 2>&1; then
            git fetch origin refs/heads/data-latest:refs/remotes/origin/data-latest
            git checkout -B data-latest refs/remotes/origin/data-latest
          else
            git checkout --orphan data-latest
            git rm -rf . || true
          fi

          mkdir -p data
          cp "${GITHUB_WORKSPACE}/public/data/embeddings.bin" data/embeddings.bin
          cp "${GITHUB_WORKSPACE}/public/data/metadata.bin" data/metadata.bin

          if [ -n "$(git status --porcelain)" ]; then
            git add data/embeddings.bin data/metadata.bin
            git commit -m "chore(data): weekly refresh bins"
            git push origin data-latest
          else
            echo "No data changes to publish"
          fi
